!function(a,b){var c=function(a){if(!(this instanceof c))throw new Error("Must instantiate using the `new` keyword");if("object"!=typeof a.targets||0===a.targets.length)throw new Error("Invalid or missing target element(s)");if("function"!=typeof a.save)throw new Error("Invalid or missing save callback");var d={form_id:"frmb-"+Date.now(),startingModel:!1,targets:!1,save:!1,sortable:!0,templateBasePath:"templates/builder",field_types:[{key:"text",label:"Text",schema:{name:!1,fbid:!1,label:"",required:!1}},{key:"textarea",label:"Textarea",schema:{name:!1,fbid:!1,label:"",required:!1}},{key:"select",label:"Select",template:"choices",schema:{name:!1,fbid:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}},{key:"radio",label:"Radio",template:"choices",schema:{name:!1,fbid:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}},{key:"checkbox",label:"Checkbox",template:"choices",schema:{name:!1,fbid:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}}]},e=this;this._opts=$.extend(!0,{},d,a),dust.onLoad===b&&(dust.onLoad=function(a,c){$.ajax(e._opts.templateBasePath+"/"+a+".tpl",{success:function(a){c(b,a)},error:function(a,d,e){c(d,b)}})});var f=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push({key:c,value:a[c].sortOrder});b.sort(function(a,b){return a.value-b.value});for(var d=[],e=0,f=b.length;f>e;e++){var g=b[e].key;d.push(a[g])}return d};return function(a){var b=a._opts.targets;if(a.render(),"object"==typeof a._opts.startingModel){a._model=a._opts.startingModel;var c=f(a._model);$.each(c,function(b,c){var d=a.getFieldTypeByName(c.type);a.addFormElementEditor(d,c)})}b.on("change",".frmb-add-elem",function(){var b=$(this).val();a.addFormElementEditor(a.getFieldTypeByName(b)),$(this).val("")}),b.on("click",".frmb-add-choice",function(b){b.preventDefault();var c=$(this),d=c.parents(".frmb-group").last(),e=d.attr("id"),f=a.getFieldTypeByName(a._model[e].type);return a.appendFieldToFormElementEditor(d,f,a._model[e]),!1}),b.on("click",".frmb-remove",function(b){b.preventDefault();var c=$(this),d=c.parents(".frmb-group:eq(0)"),e=d.attr("id");return a.removeModel(e),d.remove(),!1}),b.on("click",".frmb-choice-remove",function(b){b.preventDefault();var c=$(this),d=c.parents(".frmb-choice-group:eq(0)"),e=d.attr("id");return a.removeModel(e),d.remove(),!1}),b.on("keyup","input[type=text]",function(b){var c=$(this),d=c.parents(".frmb-group").last(),e=d.attr("id"),f=c.attr("name").replace(e+"_","");a.setModelValue(e,f,c.val())}),b.on("change","input[type=checkbox]",function(b){var c=$(this),d=c.parents(".frmb-group").last(),e=d.attr("id"),f=c.attr("name").replace(e+"_","");a.setModelValue(e,f,c.is(":checked"))}),b.on("click",".frmb-save",function(b){return b.preventDefault(),a.save(),!1})}(this),this};c.prototype={_opts:!1,_model:{},render:function(){var a=this,b={field_types:this._opts.field_types};dust.render("base",b,function(b,c){a._opts.targets.append(c)})},getFieldTypeByName:function(a){for(var b=null,c=0,d=this._opts.field_types.length;d>c;c++){var e=this._opts.field_types[c];if(e.key===a){b=e;break}}return b},addFormElementEditor:function(a,c){var d=this;if("object"!=typeof a)throw new Error("Failed to add form element editor: Invalid field object");var e=a.key+"_"+Date.now();c!==b&&"string"==typeof c.fbid?e=c.fbid:"string"==typeof a.fbid&&(e=a.fbid),"object"!=typeof c&&(d._model[e]=$.extend(!0,{},a.schema,{fbid:e,type:a.key}),c=d._model[e]);var f={fbid:e,model:c,allowsChoices:c.choices!==b};f=$.extend(!0,{},f,a),dust.render("element-base",f,function(e,f){var g=$(f),h=d._opts.targets.find("ul"),i=h.find(".frmb-group:last");return 0!==i.length?i.after(g):h.append(g),d._opts.sortable&&d._opts.targets.find("ul").sortable(),c.choices!==b?void $.each(c.choices,function(b,e){d.appendFieldToFormElementEditor(g,a,c,e,b)}):void d.appendFieldToFormElementEditor(g,a,c)})},updateModelWithSort:function(){var a=this,c=a._opts.targets.find(".frmb-group"),d=1;$.each(c,function(c,e){var f=$(e).attr("id");a._model[f]!==b&&(a._model[f].sortOrder=d),d++})},appendFieldToFormElementEditor:function(a,c,d,e,f){if(c.template!==b&&d.choices!==b){"object"!=typeof e&&(e=$.extend(!0,{},c.choiceSchema),d.choices.push(e));var g={fbid:d.fbid,model:e};f="number"==typeof f?f:d.choices.length,g.fbid+="_choices."+f,dust.render(c.template,g,function(b,c){a.find(".frmb-choices").append(c)})}},setModelValue:function(a,c,d){var e=!1;if(c.indexOf(".")>-1&&(e=c.split("."),c=e[0]),this._model[a]===b)throw new Error("Model has no entry for "+a);if(this._model[a].type===b)throw new Error("Invalid schema field "+c+" for model "+a);this.getFieldTypeByName(this._model[a].type);if("choices"===c){var f=parseInt(e[1],10)-1;if(this._model[a][c][f][e[2]]===b)throw new Error("Invalid choice schema field "+e[2]+" for model "+a);return void(this._model[a][c][f][e[2]]=d)}this._model[a][c]=d},removeModel:function(a){if(a.indexOf(".")>-1){var b=a.replace(/.*_/,""),c=b.split("."),d=parseInt(c[1],10);return a=a.replace("_"+b,""),void delete this._model[a][c[0]][d]}delete this._model[a]},setFieldNames:function(){var a=this;for(var b in a._model){var c=a._model[b];("string"!=typeof c.name||0===c.name.trim().length)&&(a._model[b].name=c.label.toLowerCase().replace(/([^a-zA-Z0-9\._-]+)/g,"-"))}},save:function(){this.updateModelWithSort(),this.setFieldNames();({form_id:this._opts.form_id,model:this._model});this._opts.save({form_id:this._opts.form_id,model:this._model})}},a.Formbuilder=c}(this);